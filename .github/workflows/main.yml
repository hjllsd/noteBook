name: Backup to WebDAV (only if recent commits)

on:
  schedule:
    - cron: '0 3 * * 1'    # 每周一 03:00 UTC
  workflow_dispatch:       # 允许手动触发（测试用）

jobs:
  check-recent-commits:
    runs-on: ubuntu-latest
    outputs:
      has_recent_commits: ${{ steps.check.outputs.has_recent }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0     # 需要完整历史来检查 commit

      - name: 检查最近7天是否有任何 commit
        id: check
        run: |
          count=$(git rev-list --after="7 days ago" HEAD --count)
          if [ "$count" -gt 0 ]; then
            echo "has_recent=true" >> $GITHUB_OUTPUT
          else
            echo "has_recent=false" >> $GITHUB_OUTPUT
          fi

   backup:
    needs: check-recent-commits
    if: ${{ needs.check-recent-commits.outputs.has_recent_commits == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    environment: webdav
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 如果后面要用 git log 可保留

      - name: 打包备份zip
        run: |
          # 调试：显示目录结构
          tree -L 2 || ls -R
          
          # 打包示例1：整个仓库（最保险，但会包含 .github/ 等）
          zip -r "backup-$(date +%Y%m%d-%H%M).zip" . -x ".git/*" "backup-*.zip" || echo "zip failed"
          
          # 打包示例2：只打包 md 文件 + 附件（更干净，推荐）
          # find . -type f \( -name "*.md" -o -name "*.png" -o -name "*.jpg" -o -name "*.pdf" \) | zip -@ "backup-$(date +%Y%m%d-%H%M).zip"
          
          ls -lh backup-*.zip   # 确认 zip 是否生成

      - name: 上传到WebDAV
        uses: bxb100/action-upload@main
        with:
          provider: webdav
          provider_options: |
            endpoint=${{ secrets.WEBDAV_URL }}
            username=${{ secrets.WEBDAV_USERNAME }}
            password=${{ secrets.WEBDAV_PASSWORD }}
          include: backup-*.zip
