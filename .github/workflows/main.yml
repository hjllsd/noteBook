name: Backup to WebDAV (Production)

on:
  schedule:
    - cron: '0 3 * * 1'
  workflow_dispatch:

jobs:
  check-recent-commits:
    runs-on: ubuntu-latest
    outputs:
      has_recent_commits: ${{ steps.check.outputs.has_recent }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 检查最近7天是否有 commit
        id: check
        run: |
          count=$(git rev-list --after="7 days ago" HEAD --count)
          echo "Recent commit count: $count"
          if [ "$count" -gt 0 ]; then
            echo "has_recent=true" >> $GITHUB_OUTPUT
          else
            echo "has_recent=false" >> $GITHUB_OUTPUT
          fi

  backup:
    needs: check-recent-commits
    if: ${{ needs.check-recent-commits.outputs.has_recent_commits == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    environment: webdav

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 打包备份
        run: |
          set -euo pipefail
          FILE_NAME="backup-$(date +%Y%m%d-%H%M%S).zip"
          zip -r "$FILE_NAME" . -x ".git/*" ".github/*" "backup-*.zip"
          echo "FILE_NAME=$FILE_NAME" >> $GITHUB_ENV
          ls -lh "$FILE_NAME"

      - name: 创建远程目录
        run: |
          set -euo pipefail
          BASE="${{ secrets.WEBDAV_URL }}"
          AUTH="${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}"
          MONTH=$(date +%Y-%m)
          for path in "backups" "backups/github" "backups/github/noteBook" "backups/github/noteBook/$MONTH"; do
            curl -s -o /dev/null -w "%{http_code}" -X MKCOL -u "$AUTH" "$BASE/$path" || true
          done

      - name: 上传备份
        run: |
          set -euo pipefail
          MONTH=$(date +%Y-%m)
          curl -f -T "$FILE_NAME" \
            -u "${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}" \
            "${{ secrets.WEBDAV_URL }}/backups/github/noteBook/$MONTH/$FILE_NAME"
          echo "Upload complete: $FILE_NAME"

      - name: 删除30天前旧备份
        run: |
          AUTH="${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}"
          BASE="${{ secrets.WEBDAV_URL }}/backups/github/noteBook"
          now_ts=$(date +%s)
          curl -s -u "$AUTH" -X PROPFIND "$BASE/" -H "Depth: 2" \
            | grep -oE 'backup-[0-9]{8}-[0-9]{6}\.zip' | sort -u \
            | while read file; do
              file_date=$(echo "$file" | grep -oE '[0-9]{8}')
              file_ts=$(date -d "$file_date" +%s 2>/dev/null || echo 0)
              diff_days=$(( (now_ts - file_ts) / 86400 ))
              if [ "$diff_days" -gt 30 ]; then
                echo "Deleting: $file"
                curl -s -X DELETE -u "$AUTH" "$BASE/*/$file" || true
              fi
            done
