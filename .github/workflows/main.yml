name: Backup to WebDAV (Production)

on:
  schedule:
    - cron: '0 3 * * 1'
  workflow_dispatch:

jobs:
  check-recent-commits:
    runs-on: ubuntu-latest
    outputs:
      has_recent_commits: ${{ steps.check.outputs.has_recent }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 检查最近7天是否有 commit
        id: check
        run: |
          count=$(git rev-list --after="7 days ago" HEAD --count)
          echo "Recent commit count: $count"
          if [ "$count" -gt 0 ]; then
            echo "has_recent=true" >> $GITHUB_OUTPUT
          else
            echo "has_recent=false" >> $GITHUB_OUTPUT
          fi

  backup:
    needs: check-recent-commits
    if: ${{ needs.check-recent-commits.outputs.has_recent_commits == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    environment: webdav

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 打包备份
        run: |
          set -euo pipefail
          FILE_NAME="backup-$(date +%Y%m%d-%H%M%S).zip"

          zip -r "$FILE_NAME" . \
            -x ".git/*" \
               ".github/*" \
               "backup-*.zip"

          echo "Generated:"
          ls -lh "$FILE_NAME"

      - name: 创建远程目录（自动）
        run: |
          set -euo pipefail
          BASE="${{ secrets.WEBDAV_URL }}"
          AUTH="${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}"
          MONTH=$(date +%Y-%m)

          echo "Creating remote directories..."

          curl -s -X MKCOL -u "$AUTH" "$BASE/backups" || true
          curl -s -X MKCOL -u "$AUTH" "$BASE/backups/github" || true
          curl -s -X MKCOL -u "$AUTH" "$BASE/backups/github/noteBook" || true
          curl -s -X MKCOL -u "$AUTH" "$BASE/backups/github/noteBook/$MONTH" || true

      - name: 上传备份
        run: |
          set -euo pipefail
          FILE=$(ls backup-*.zip | head -n 1)
          MONTH=$(date +%Y-%m)

          echo "Uploading $FILE ..."
          curl -f -T "$FILE" \
            -u "${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}" \
            "${{ secrets.WEBDAV_URL }}/backups/github/noteBook/$MONTH/$FILE"

          echo "Upload complete."

      - name: 删除30天前旧备份
        run: |
          set -euo pipefail
          AUTH="${{ secrets.WEBDAV_USERNAME }}:${{ secrets.WEBDAV_PASSWORD }}"
          BASE="${{ secrets.WEBDAV_URL }}/backups/github/noteBook"

          echo "Cleaning backups older than 30 days..."

          # 获取文件列表
          curl -s -u "$AUTH" -X PROPFIND "$BASE/" \
            -H "Depth: 2" \
            | grep -oE 'backup-[0-9]{8}-[0-9]{6}\.zip' \
            | sort -u \
            | while read file; do

              file_date=$(echo "$file" | cut -d'-' -f2)
              file_ts=$(date -d "$file_date" +%s || echo 0)
              now_ts=$(date +%s)
              diff_days=$(( (now_ts - file_ts) / 86400 ))

              if [ "$diff_days" -gt 30 ]; then
                echo "Deleting old backup: $file"
                curl -s -X DELETE -u "$AUTH" "$BASE/*/$file" || true
              fi
            done
