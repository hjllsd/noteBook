name: Backup to WebDAV (only if recent commits)

on:
  schedule:
    - cron: '0 3 * * 1'    # 每周一 03:00 UTC
  workflow_dispatch:       # 允许手动触发（测试用）

jobs:
  check-recent-commits:
    runs-on: ubuntu-latest
    outputs:
      has_recent_commits: ${{ steps.check.outputs.has_recent }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 检查最近7天是否有任何 commit
        id: check
        run: |
          count=$(git rev-list --after="7 days ago" HEAD --count)
          echo "Recent commit count: $count"
          if [ "$count" -gt 0 ]; then
            echo "has_recent=true" >> $GITHUB_OUTPUT
          else
            echo "has_recent=false" >> $GITHUB_OUTPUT
          fi

  backup:
    needs: check-recent-commits
    if: ${{ needs.check-recent-commits.outputs.has_recent_commits == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    environment: webdav
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 打包备份 zip
        run: |
          set -e
          tree -L 2 || ls -R

          FILE_NAME="backup-$(date +%Y%m%d-%H%M).zip"

          zip -r "$FILE_NAME" . \
            -x ".git/*" \
               ".github/*" \
               "backup-*.zip"

          ls -lh "$FILE_NAME"

      - name: 上传到 WebDAV
        uses: bxb100/action-upload@main
        with:
          provider: webdav
          provider_options: |
            endpoint=${{ secrets.WEBDAV_URL }}
            username=${{ secrets.WEBDAV_USERNAME }}
            password=${{ secrets.WEBDAV_PASSWORD }}
          include: backup-*.zip
