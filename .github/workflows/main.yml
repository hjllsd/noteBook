name: Backup to WebDAV (only if recent commits)

on:
  schedule:
    - cron: '0 3 * * 1'      # 每周一 03:00 UTC
  workflow_dispatch:         # 允许手动触发（测试用）

jobs:
  check-recent-commits:
    runs-on: ubuntu-latest
    outputs:
      has_recent_commits: ${{ steps.check.outputs.has_recent }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0       # 需要完整历史才能检查 rev-list

      - name: 检查最近7天是否有任何 commit
        id: check
        run: |
          # 检查最近7天是否有任何 commit（从 HEAD 往前看）
          if git rev-list --after="7 days ago" HEAD --count | grep -q "[1-9]"; then
            echo "has_recent=true" >> $GITHUB_OUTPUT
          else
            echo "has_recent=false" >> $GITHUB_OUTPUT
          fi

  backup:
    needs: check-recent-commits
    if: ${{ needs.check-recent-commits.outputs.has_recent_commits == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 打包备份zip
        run: |
          zip -r backup-$(date +%Y%m%d).zip docs/ config/ .github/

      - name: 上传到WebDAV
        uses: bxb100/action-upload-webdav@v1
        with:
          webdav_address: ${{ secrets.WEBDAV_URL }}
          webdav_username: ${{ secrets.WEBDAV_USERNAME }}
          webdav_password: ${{ secrets.WEBDAV_PASSWORD }}
          source_path: backup-*.zip
          # remote_path: backups/github/my-repo/   # 可选
          # overwrite: true                        # 可选，根据需要
